"use strict";angular.module("blogTemplateApp",["ngCookies","ngResource","ngSanitize","ngRoute","ui.sortable"]).config(["$routeProvider","$locationProvider",function(a){a.otherwise({redirectTo:"/"})}]),angular.module("blogTemplateApp").controller("BBCoreCtrl",["$sce","$rootScope","$scope","$route","$routeParams","$location","user",function(a,b,c,d,e,f,g){c.bbcore={},c.bbcore.user=g,c.bbcore.edit=!0,c.bbcore.selectedElement="",c.versions=[],c.bbcore.sortablePageMenuOptions={start:function(){c.bbcore.snapShot()},update:function(){c.bbcore.updateHistorial()},axis:"y"},c.bbcore.user.logIn("dev","default");var h=function(){var a=new Parse.Query("Site");a.equalTo("objectId",siteConfig.id),a.find().then(function(a){JSON.parse(a[0].get("schema"));return console.log("Schema"+JSON.parse(a[0].get("schema"))),c.bbcore.site=JSON.parse(a[0].get("schema")),c.bbcore.siteQuery=a,c.$apply(),c.bbcore.site}).then(function(a){c.bbcore.site=a,d.routes[""]={keys:[],originalPath:"",redirectTo:"/",regexp:/^$/};var e;for(e=0;e<a.pages.length;e++){var g=a.pages[e],h=g.url,i=new RegExp("^\\/"+h+"$"),j="/"+h,k="";"/"===h?(k=h,i=new RegExp("^\\"+h+"$"),j=h):k="/"+h,d.routes[k]={keys:[],originalPath:j,regexp:i,reloadOnSearch:!0,templateUrl:"views/_page.html"},"/"!==h&&(i=new RegExp("^\\/"+h+"\\/$"),d.routes[k+"/"]={keys:[],originalPath:j+"/",regexp:i,reloadOnSearch:!0,redirectTo:k})}d.reload(),b.$on("$routeChangeSuccess",function(){c.currentPath=f.path(),c.currentPage=a.pages.filter(function(a){return a.url===c.currentPath||a.url===c.currentPath.replace("/","")?a.content:void 0})[0],c.versions=[]})})};h(),c.bbcore.snapShot=function(){c.beforeSite=JSON.parse(JSON.stringify(c.bbcore.site)),console.log("snapShot"+c.beforeSite)},c.bbcore.updateHistorial=function(){c.versionIndex&&c.versions&&(c.versions=c.versions.slice(0,c.versionIndex)),c.beforeSite.pages&&(c.$apply(),c.versions.push(c.beforeSite.pages),c.beforeSite=[],c.versionIndex=c.versions.length,console.log("::versions:length: "+c.versions.length),console.log("::versionIndex:: "+c.versionIndex))},c.bbcore.addPage=function(a,b,e){var f=c.bbcore.site.pages.length+1,g={id:f,title:a,description:a,type:"page",content:e,url:b};c.bbcore.site.pages.push(g);var h=new RegExp("^\\/"+b+"$"),i="/"+b,j="";return"/"===b?(j=b,h=new RegExp("^\\"+b+"$"),i=b):j="/"+b,d.routes[j]={keys:[],originalPath:i,regexp:h,reloadOnSearch:!0,templateUrl:"views/_page.html"},"/"!==b&&(h=new RegExp("^\\/"+b+"\\/$"),d.routes[j+"/"]={keys:[],originalPath:i+"/",regexp:h,reloadOnSearch:!0,redirectTo:j}),g},c.toggleEdition=function(){c.bbcore.edit=c.bbcore.edit===!0?!1:!0},c.trustedHtml=function(b){return a.trustAsHtml(b)}}]).controller("MainCtrl",["$scope","$route",function(){}]),angular.module("blogTemplateApp").factory("Site",function(){if(localStorage.bbSite01)var a=JSON.parse(localStorage.bbSite01);else var a={siteName:"Dental Solutions",metaData:{siteTitle:"Babel Blogs, Multi-lingual Web Systems",keywords:"",description:""},design:{theme:"demo",customCSS:"/path/",favicon:"/path/",logo:"/path/",appIcons:{ios:{0:"/* IOS ICONS */"},android:{0:"/* ANDROID ICONS */"},windows:{0:"/* WINDOWS ICONS */"},blackberry:{0:"/* BLACKBERRY ICONS */"},kindle:{0:"/* KINDLE ICONS */"},tizen:{0:"/* TIZEN ICONS */"}}},pages:[{description:"Home Page.",pageId:"0",parentId:"",sectionID:"",title:"Home",url:"/",metaData:{googlePlus:{name:"",description:"",image:""},twitter:{card:"summary_large_image",site:"http://mysite.com",title:"Page Title",description:"Description of the page",creator:"Babel Blogs, LLC"},openGraph:{title:"",type:"",url:"",image:"",description:"",site_name:"Babel Blogs Demo"},seo:{title:"",description:""}},content:'<div id="bb-rich-text1" bb-element="bb-image"><img src="/images/custom/dentist.jpg" alt=""></div>						<div id="bb-rich-text2" bb-element="bb-rich-text"><h2>We are experts in dental solutions.</h2></div>'},{description:"About Us.",pageId:"1",parentID:"",sectionID:"",title:"About US",url:"about",metaData:{googlePlus:{name:"",description:"",image:""},twitter:{card:"summary_large_image",site:"http://mysite.com",title:"Page Title",description:"Description of the page",creator:"Babel Blogs, LLC"},openGraph:{title:"",type:"",url:"",image:"",description:"",site_name:"Babel Blogs Demo"},seo:{title:"",description:""}},content:'<div id="bb-rich-text1" bb-element="bb-rich-text" style="width: 460px;"><p>I\'m a paragraph. Click here to add your own text and edit me. It’s easy. Just click “Edit Text” or double click me and you can start adding your own content and make changes to the font. Feel free to drag and drop me anywhere you like on your page. I’m a great place for you to tell a story and let your users know a little more about you.						​						<br/><br/>This is a great space to write long text about your company and your services. You can use this space to go into a little more detail about your company. Talk about your team and what services you provide. Tell your visitors the story of how you came up with the idea for your business.</p></div>						<div bb-element="bb-image"><img src="/images/custom/dentist02.jpg" alt="" width="320"></div>'}]};return a}).factory("user",["$location","$rootScope",function(a,b){return{logIn:function(a,c){return b.$broadcast("event:sessionUpdated"),Parse.User.logIn(a,c)},logOut:function(){Parse.User.logOut(),b.$broadcast("event:sessionUpdated"),this.isLogin=!1},current:function(){return Parse.User.current()},isAuthenticated:function(){return Parse.User.current()?(this.isLogin=!0,!0):(this.isLogin=!1,!1)},isLogin:!1}}]);var generateUid=function(a){function b(){return(65536*(1+Math.random())|0).toString(16).substring(1)}var c=a||"-";return b()+b()+c+b()+c+b()+c+b()+c+b()+b()+b()};angular.module("blogTemplateApp").directive("compileHtml",["$compile",function(a){return{restrict:"A",replace:!0,link:function(b,c,d){b.$watch(d.compileHtml,function(d){c.html(d),a(c.contents())(b)})}}}]).directive("bbContent",["$compile","$document","$rootScope","$location","$route","Site",function(a,b,c){return{restrict:"A",scope:!1,link:function(a,b){var d=($(this),"#WYSIWYGModal"),e="editor1",f=function(){CKEDITOR.replace("editor1",{allowedContent:!0})},g=function(){b.find("*").removeAttr("draggable");var c=a.currentPage.pageId,d=$("#content *[compile-html]").html();a.bbcore.site.pages[c].content=d};c.$on("$routeChangeStart",function(){g()}),b.on("click","*",function(){$(this).attr("bb-element")&&(console.log("isComponent"),console.log($(this)),$(this).attr("draggable",""));var b=a.currentPage.pageId,c=$("#content *[compile-html]").html();a.bbcore.site.pages[b].content=c,a.$apply()}),b.on("dblclick",'*[bb-element="bb-rich-text"]',function(){var c=$(this).attr("id");a.bbcore.snapShot(),a.richTextEditing=$(this).html(),CKEDITOR.instances[e]?(CKEDITOR.instances[e].destroy(),f()):f();var g=CKEDITOR.instances[e];g.setData(a.richTextEditing),$(d).modal("show"),$(d).on("click","*[data-apply]",function(){var f=CKEDITOR.instances[e];f&&(b.find("#"+c).html(f.getData()),f.destroy());var g=a.currentPage.pageId,h=$("#content *[compile-html]").html();a.bbcore.site.pages[g].content=h,a.$apply(),a.bbcore.updateHistorial(),$(d).modal("hide")}),$(d).on("click","*[data-remove]",function(){var e=a.currentPage.pageId,f=$("#content *[compile-html]").html();b.find("#"+c).remove(),a.bbcore.site.pages[e].content=f,a.$apply(),g.destroy(),$(d).modal("hide")}),b.on("click","*[data-dismiss]",function(){g.destroy(),$("#pageSettingsModal").modal("hide")})})},replace:!1}}]).directive("draggable",["$document",function(a){return function(b,c){function d(a){j=a.screenY-h,i=a.screenX-g,c.css({top:j+"px",left:i+"px"})}function e(){a.off("mousemove",d),a.off("mouseup",e)}var f=c.position(),g=0,h=0,i=f.left,j=f.top;c.on("mousedown",function(c){b.$apply(),b.bbcore.snapShot(),c.preventDefault(),g=c.screenX-i,h=c.screenY-j,a.on("mousemove",d),a.on("mouseup",e)}),c.on("mouseup",function(){var a=b.currentPage.pageId,c=$("#content *[compile-html]").html();b.bbcore.site.pages[a].content=c,b.$apply(),b.bbcore.updateHistorial()})}}]).directive("bbToolBar",["$location","$route","Site",function(){return{restrict:"A",scope:!1,link:function(a,b){b.on("click","*[data-undo]",function(){if(console.log("::scope.bbcore.site.pages:before:"+a.bbcore.site.pages),console.log("::scope.bbcore.site.pages.lenght:before:"+a.bbcore.site.pages.length),console.log("::scope.versions:before:"+a.versions),console.log("::scope.versions:lenght:before:"+a.versions.length),a.bbcore.edit===!0&&a.versions.length>0){var b=a.currentPage.pageId;a.versionIndex>0&&(a.bbcore.site.pages=a.versions[a.versionIndex-1],a.versionIndex=a.versionIndex-1),console.log("::scope.bbcore.site.pages:after:"+a.bbcore.site.pages),console.log("::scope.bbcore.site.pages.lenght:after:"+a.bbcore.site.pages.length),console.log("::scope.versions:after:"+a.versions),console.log("::scope.versions:lenght:after:"+a.versions.length),a.currentPage=a.bbcore.site.pages.filter(function(a){return a.pageId===b?a:void 0})[0],a.$apply()}}),b.on("click","*[data-repeat]",function(){if(a.bbcore.edit===!0&&a.versions){console.log("Repeating..."),console.log("scope.currentPage:Before:"+JSON.stringify(a.currentPage));var b=a.currentPage.pageId;a.versionIndex+1<a.versions.length&&(a.bbcore.site.pages=a.versions[a.versionIndex+1],a.versionIndex=a.versionIndex+1),a.currentPage=a.bbcore.site.pages.filter(function(a){return a.pageId===b?a:void 0})[0],console.log("scope.currentPage:After:"+JSON.stringify(a.currentPage)),a.$apply()}}),b.on("click","*[data-save]",function(){!function(){$("*").removeAttr("draggable");var b=a.currentPage.pageId,c=$("#content *[compile-html]").html();a.bbcore.site.pages[b].content=c}(),a.bbcore.siteQuery[0].set("schema",JSON.stringify(a.bbcore.site)),a.bbcore.siteQuery[0].save()})},templateUrl:"scripts/directives/_toolbar.html",replace:!0,transclude:!1}}]).directive("bbToolBox",["$rootScope","$location","$route","Site",function(a,b,c){return{restrict:"A",scope:!1,link:function(d,e){e.on("click","li",function(){var a=$(this).data("id");$(a).toggleClass("hide"),f()});var f=function(){var a=b.path(),c="";c="/"!==a?a.replace("/","#"):a,e.find("#page-list li a[ng-href]").parent().removeClass("active"),e.find('#page-list li a[ng-href="'+c+'"]').parent().addClass("active")};f();a.$on("$routeChangeSuccess",function(){f()}),e.on("click","li[data-page-add]",function(){var a="#AddPageModal";$(a).modal("show"),$(a).on("click","*[data-apply]",function(){var c=d.NewPage.title,e=c.split(" ").join("-").toLowerCase(),f=d.bbcore.addPage(c,e,'<div id="bb-rich-text1" bb-element="bb-rich-text"><p>Double click here in order to edit this paragraph</p></div>');b.path(f.url),d.$apply(),$(a).modal("hide")})}),e.on("click","li *[data-page-id]",function(){var a="#pageSettingsModal",e=$(this).data("page-id");d.beforeSite=JSON.parse(JSON.stringify(d.bbcore.site)),d.PageEditing=d.bbcore.site.pages[e],b.path(d.PageEditing.url),d.$apply(),$(a).modal("show"),$(a).on("click","*[data-remove]",function(){var b=d.PageEditing.pageId;d.bbcore.site.pages.splice(b,1),d.PageEditing={},d.$apply(),$(a).modal("hide")}),$(a).on("click","*[data-dismiss]",function(){d.bbcore.site=d.beforeSite=JSON.parse(JSON.stringify(d.beforeSite)),d.$apply(),$(a).modal("hide")}),$(a).on("click","*[data-apply]",function(){var b=d.beforeSite.pages[d.PageEditing.pageId].url,e=d.PageEditing.url,f=c.routes["/"+b+"/"],g=new RegExp("^/"+e+"$");f.originalPath="/"+e,f.regexp=g,c.routes["/"+e+"/"]=f,delete c.routes["/"+b+"/"],d.$apply(),c.reload(),$(a).modal("hide")})}),e.on("click","*[data-insert-text]",function(){var a=$('*[bb-element="bb-rich-text"]').length,b=generateUid(),c=460+32*a,d=120+32*a;a+=1,$("#content *[compile-html]").append($('<div id="bb'+b+'" bb-element="bb-rich-text" style="left:'+c+"px; top:"+d+"px; position:absolute\"><p jqyoui-draggable=\"{data-drag: 'true'}\">I'm a paragraph, double click here in order to add<br/>your own text.</p></div>"))})},templateUrl:"scripts/directives/_toolbox.html",replace:!0,transclude:!1}}]);